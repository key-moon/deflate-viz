<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>Deflate 可視化 + Zopfli圧縮 (Vite)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{
        --bg:#0b1020; --panel:#121a2e; --ink:#e8f0ff; --muted:#9db1d0; --accent:#5ac8fa;
        --bad:#ff5e57; --ok:#32d74b; --chip:#223050;
        --blocks-height: 340px;
        --refch:#5d1919; /* 参照中の文字色（指定値） */
      }
      *{box-sizing:border-box}
      body{margin:0; background:var(--bg); color:var(--ink); font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji");}

      /* ヘッダー：1行・固定高・右にメッセージ */
      header{
        position:sticky; top:0; z-index:10;
        height:56px; min-height:56px; max-height:56px;
        padding:0 12px; display:flex; align-items:center; justify-content:space-between;
        background:linear-gradient(to bottom, rgba(18,26,46,.95), rgba(18,26,46,.65));
        backdrop-filter: blur(6px); border-bottom:1px solid rgba(255,255,255,.06);
      }
      header .title{display:flex; align-items:center; gap:10px}
      header h1{margin:0; font-size:16px; color:var(--accent); white-space:nowrap}
      header .controls{display:flex; align-items:center; gap:8px}
      header .status{display:flex; align-items:center; gap:12px; min-width:240px; justify-content:flex-end}
      .small{font-size:12px} .muted{color:var(--muted)} .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,"Noto Sans Mono",Consolas,"Liberation Mono"}
      .err{color:var(--bad); white-space:pre; max-width:45vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
      .success{color:var(--ok); white-space:nowrap}
      .hidden{visibility:hidden}

      /* レイアウト */
      .stack{display:grid; grid-template-rows: auto 1fr; gap:8px; height:calc(100vh - 56px); padding:8px;}
      .row{display:grid; grid-template-columns: 1fr 1fr; gap:8px; min-height:0;}
      #row-top{grid-template-columns:1fr;}
      .panel{background:var(--panel); border:1px solid #233353; border-radius:12px; overflow:hidden; min-height:0;}
      .panel h2{margin:0; font-size:13px; color:#cfe3ff}
      .panel .h2bar{display:flex; justify-content:space-between; align-items:center; padding:8px 12px;}
      .section{padding:10px 12px; border-top:1px solid rgba(255,255,255,.06)}
      .rowline{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

      .btn{
        display:inline-flex; align-items:center; gap:6px;
        height:32px; padding:0 10px; border-radius:8px; border:1px solid #243151;
        background:#0f1527; color:var(--ink); cursor:pointer; user-select:none;
      }
      .btn:hover{filter:brightness(1.08)}
      .btn svg{width:18px; height:18px; fill:#cfe3ff}
      .btn .text{font-size:12px}
      .sep{width:1px; height:22px; background:#243151; margin:0 2px}
      input[type="text"], textarea{
        background:#0f1527; color:var(--ink); -webkit-text-fill-color:var(--ink); border:1px solid #243151; border-radius:8px; padding:8px; outline:none;
      }
      #hex,#b64{color:var(--ink); -webkit-text-fill-color:var(--ink);}
      textarea{height:64px; resize:vertical}

      /* ドラッグ&ドロップ */
      #inputModal.drop{outline:2px dashed var(--accent); outline-offset:-6px; box-shadow: inset 0 0 0 9999px rgba(90,200,250,.08);}
      #inputModal{width:500px; max-width:90vw; padding:0;}
      #inputModal::backdrop{background:rgba(0,0,0,.5);}

      /* ブロック情報（固定高スクロール） */
      #pane-blocks{height:var(--blocks-height); display:flex; flex-direction:column;}
      #blocksScroll{flex:1 1 auto; overflow:auto; padding:4px 12px 10px;}
      .blocks{display:flex; flex-direction:column; gap:8px;}
      .block{border:1px solid #2b3c61; border-radius:10px; padding:8px; background:#0f1527}
      .block h3{margin:0 0 6px 0; font-size:14px; color:#cfe3ff}
      .chipline{display:flex; gap:6px; flex-wrap:wrap; margin:4px 0 6px 0}
      .chip{background:#223050; border:1px solid #2b3c61; padding:2px 8px; border-radius:999px; color:#cfe3ff; font-size:12px}
      .muteline{color:#9db1d0; font-size:12px; margin-top:2px}

      /* 長さごとのシンボル表 */
      .len-table{width:100%; border-collapse:collapse; font-size:12px; margin-top:6px}
      .len-table th,.len-table td{border-bottom:1px solid #253757; padding:3px 4px; text-align:left; vertical-align:top}
      .len-table th{color:#9db1d0; position:sticky; top:0; background:#0f1527}
      .mono-small{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,"Noto Sans Mono",Consolas,"Liberation Mono"; font-size:12px}
      .wrap{word-break:break-word; white-space:normal}

      /* 0..127 ヒートマップ */
      .codegrid{
        display:grid;
        grid-template-columns: repeat(64, 1fr);
        gap:1px;
        background:#12203b;
        border:1px solid #2b3c61;
        border-radius:8px;
        padding:4px;
        margin-top:6px;
      }
      .codecell{
        font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,"Noto Sans Mono",Consolas,"Liberation Mono";
        font-size:10px;
        line-height:1.6;
        text-align:center;
        border-radius:3px;
        color:#e6f1ff;
        min-height:16px;
        user-select:text;
        tab-size:2; -moz-tab-size:2;
      }
      .codecell.missing{ color:#7a8aa0; background:transparent; }
      .codecell.hit{ outline:2px solid var(--accent); outline-offset:-2px; }

      .heatmap-row{display:flex; gap:8px; margin-top:6px}
      .hm-half{flex:0 0 50%}
      .hm-quarter{flex:0 0 25%}

      /* エディタ */
      #editorWrap{height:100%; display:flex; flex-direction:column;}
      #editor{width:100%; flex:1 1 auto; border-radius:12px; min-height:120px; tab-size:2; -moz-tab-size:2;}

      /* 見出し右側の iterations スライダ */
      #iterControls{display:flex; align-items:center; gap:8px;}
      #iterControls label{font-size:12px; color:#9db1d0}
      #iter{width:200px; height:4px;}
      #iterVal{min-width:2ch; display:inline-block}

      /* 可視化（縦スクロールのみ、横禁止） */
      #pane-viz{display:flex; flex-direction:column; min-height:0;}
      #vizHeader{padding:8px 12px 0;}
      #vizScroll{flex:1 1 auto; overflow-y:auto; overflow-x:hidden; padding:10px 12px; min-height:0;}
      .viz{
        white-space:pre-wrap;           /* 改行保持＋折り返し */
        overflow-wrap:anywhere;         /* 横スクロール禁止 */
        word-break:break-word;
        max-width:100%;
        tab-size:2; -moz-tab-size:2;   /* タブ幅=2（可視化側） */
        font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,"Cascadia Mono","Noto Sans Mono",Consolas,"Liberation Mono";
      }

      /* トークン（MATCH は縁取りのみ、色は #3349b8） */
      ruby.tok{position:relative; display:inline-block; border-radius:6px; padding:0 .5px}
      ruby.tok.lit{ /* JSで背景色を付与 */ }
      ruby.tok.raw{ /* JSで背景色を付与 */ }
      ruby.tok.match{
        background:transparent !important; /* 塗りなし */
        border:1px solid #3349b8;       /* 縁取り */
        padding:0 .5px; border-radius:6px;
        box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
      }
      /* 改行分断時の境界調整 */
      ruby.tok.match.frag-mid{ border:none; border-radius:0; box-shadow:none; }
      ruby.tok.match.frag-start{ border-right:none; border-top-right-radius:0; border-bottom-right-radius:0; }
      ruby.tok.match.frag-end{ border-left:none; border-top-left-radius:0; border-bottom-left-radius:0; }
      ruby.tok.frag-mid{ border-radius:0; }
      /* 同一トークン断片強調 & クリック固定 */
      ruby.tok.same-token{
        outline:1px solid rgba(90,200,250,.35);
        outline-offset:1px;
      }
      ruby.tok.hit{
        box-shadow: inset 0 0 0 2px #3349b8, 0 0 0 2px rgba(51,73,184,.25);
        border-color:#5c71e0;
      }
      /* 参照元ハイライト（文字単位） */
      .ch{white-space:pre;}
      .ch.refch{
        font-weight:700;
        color:var(--refch);
        text-shadow: 0 0 0.5px rgba(255,255,255,.25);
      }
      ruby.tok.ref-target{
        box-shadow: inset 0 0 0 2px #3349b8, 0 0 0 2px rgba(51,73,184,.25);
        border-color:#5c71e0;
      }
      /* ルビ（下側に出す） */
      ruby.tok rt{
        position:absolute; left:0; bottom:-1.35em;
        font-size:10px; line-height:1; background:#0008; padding:2px 4px; border-radius:4px; color:#eff7ff;
        white-space:nowrap; pointer-events:none; opacity:0; transform:translateY(2px); transition:opacity .08s ease, transform .08s ease;
        z-index:10;
      }
      ruby.tok:hover rt{opacity:1; transform:translateY(0)}
      ruby.tok rb{white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word; tab-size:2; -moz-tab-size:2;}

      /* 凡例（min | bar | max の3カラム） */
      .legend{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
      .chip2{background:#223050; border:1px solid #2b3c61; padding:3px 8px; border-radius:999px; color:#9db1d0; font-size:12px}
      .legend-lit{
        display:grid;
        grid-template-columns:auto 1fr auto;
        align-items:center;
        gap:8px;
        min-width:320px;
      }
      .legend-lit .scale{font-size:10px; color:#8aa4c7}
      .legend-lit .bar{
        width:100%; height:10px; border-radius:999px; border:1px solid #2b3c61; background:#1a2746; box-shadow: inset 0 0 0 1px #12203b;
      }
      .inlineStat{margin-left:8px}
    </style>
  </head>
  <body>
    <header>
      <div class="title">
        <h1>Deflate 可視化 + Zopfli圧縮（Vite/ESM）</h1>
      </div>
      <div class="controls">
        <button id="btn-input" class="btn" title="入力">
          <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16l4-4h10a2 2 0 0 0 2-2V8l-6-6zM13 9V3.5L18.5 9H13z"/></svg>
          <span class="text">入力</span>
        </button>
        <span class="sep"></span>
        <input id="rawMode" type="checkbox" checked />
        <label for="rawMode" class="small">生DEFLATE</label>
        <span class="sep"></span>
        <button id="btn-share" class="btn" title="URLを共有">
          <svg viewBox="0 0 24 24"><path d="M18 8a3 3 0 1 0-2.83-4H12v2h3.17A3 3 0 0 0 18 8zm-3 8H8a3 3 0 1 0 0 2h7v2l4-3-4-3v2zM12 10H8v2h4v2l4-3-4-3v2z"/></svg>
          <span class="text">共有</span>
        </button>
      </div>
      <div class="status">
        <span id="error" class="err hidden"></span>
        <span id="success" class="success hidden"></span>
      </div>
    </header>

    <dialog id="inputModal" class="panel">
      <h2 class="h2bar"><span>入力</span></h2>
      <div class="section">
        <input id="fileInput" type="file" accept=".deflate,.zlib,.bin,.raw,*/*" style="display:none" />
        <button id="btn-file" class="btn" title="ファイルを読み込む（クリック or ドラッグ＆ドロップ）">
          <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16l4-4h10a2 2 0 0 0 2-2V8l-6-6zM13 9V3.5L18.5 9H13z"/></svg>
          <span class="text">読み込み / DD</span>
        </button>
      </div>
      <div class="section">
        <div class="rowline"><label class="small">16進入力（スペース/改行OK）</label></div>
        <textarea id="hex" class="mono" placeholder=""></textarea>
        <div class="rowline">
          <label class="small">Base64</label>
          <input id="b64" type="text" class="mono" placeholder="" />
        </div>
      </div>
      <div class="section" style="text-align:right">
        <button id="btn-close" class="btn"><span class="text">閉じる</span></button>
      </div>
    </dialog>

    <div class="stack">
      <!-- 上段 -->
      <div class="row" id="row-top">
        <div class="panel" id="pane-blocks">
          <h2 class="h2bar">
            <span>ブロック情報（要約 + 0–127 ヒートマップ + 長さ別シンボル表）</span>
            <div class="legend-lit" aria-label="使用回数スケール（小=赤, 大=緑）">
              <div class="scale small">count</div>
              <div class="bar" id="countLegendBar"></div>
              <div class="scale"><span id="countLegendMax" class="small">0</span></div>
            </div>
          </h2>
          <div id="blocksScroll"><div id="blocks" class="blocks"></div></div>
          <div id="zlibNote" class="small muted" style="padding:6px 12px"></div>
        </div>
      </div>

      <!-- 下段 -->
      <div class="row" id="row-bottom">
        <div class="panel" id="pane-editor">
          <h2 class="h2bar">
            <span>
              エディタ (Python, 変更で即Zopfli圧縮)
              <span class="chip2 small mono inlineStat">code <span id="codeLen">0</span></span>
            </span>
            <div id="iterControls" class="ctl">
              <label for="iter">Zopfli iterations:</label>
              <input id="iter" type="range" min="1" max="50" step="1" value="10" />
              <span class="small mono" id="iterVal">10</span>
            </div>
          </h2>
          <div id="editorWrap">
            <div id="editor">def p(g):
 for u in range(len(g)):
  for l in range(len(g[0])):
   r=[*g[u],0].index(0,l);d=[*(g[k][l]for k in range(len(g))),0].index(0,u)
   if g[u][l]==2and r-l&gt;5&lt;d-u:
    t=[s[l:r]for s in g[u:d]]
    for _ in range(8):
     for i in range(len(g)-2):
      for j in range(len(g[0])-2):
       for y in range(len(t)-2):
        for x in range(len(t[0])-2):
         if all(g[i+k][j+m]==2if t[y+k][x+m]==0else g[i+k][j+m]|2!=2for k in range(3)for m in range(3))*(y&lt;1or 0!=t[y-1][x+1])*(y+4&gt;len(t)or 0!=t[y+3][x+1]):
          for k in range(3):
           for m in range(3):t[y+k][x+m]=g[i+k][j+m];g[i+k][j+m]=0
     *t,=map(list,zip(*t[::-1]))
    return t</div>
          </div>
        </div>

        <div class="panel" id="pane-viz">
          <h2 class="h2bar">
            <span>
              可視化（トークン彩色 & ルビ注釈）
              <span class="chip2 small mono inlineStat">deflate <span id="deflateLen">0</span> B</span>
            </span>
          </h2>
          <div id="vizHeader">
            <div class="legend">
              <span class="chip2 small">ホバー: 種別/パラメータ/bit長・参照先 / クリック: 固定ハイライト</span>
              <div class="legend-lit" aria-label="LITビット長スケール（緑=短, 赤=長）">
                <div class="scale"><span id="litLegendMin">1b</span></div>
                <div class="bar" id="litLegendBar" title="LIT token bit-length scale"></div>
                <div class="scale"><span id="litLegendMax">9b</span></div>
              </div>
            </div>
          </div>
          <div id="vizScroll">
            <div id="output" class="viz"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Viteエントリ -->
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
